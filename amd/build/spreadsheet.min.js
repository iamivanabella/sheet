define(["qtype_sheet/customformula_irr","qtype_sheet/toolbar"],function(e,t){return{init:function(l=!1){let n=document.getElementById("spreadsheet-editor"),a=document.getElementById("formula-bar"),o=document.getElementById("id_spreadsheetdata"),r=JSON.parse(o.value||'{"data":[], "meta":[]}');var i=r.data.length>0?r.data:Array(26).fill(Array(26).fill("")),d=r.meta||[];let s=null,c=[],u=!1,f="",y=!1,E=null,g=!1,A=!1,v=null,h=null,m=!1;document.addEventListener("keydown",e=>y="Shift"===e.key||y),document.addEventListener("keyup",e=>y="Shift"!==e.key&&y);var p=new Handsontable(n,{data:i,meta:d,rowHeaders:!0,colHeaders:!0,contextMenu:!!l&&["make_read_only"],width:"100%",height:"100%",rowCount:26,colCount:26,formulas:{engine:e},licenseKey:"non-commercial-and-evaluation",cells:function(e,t){var l={};return d.forEach(function(n){n.row===e&&n.col===t&&(n.readOnly&&(l.readOnly=!0),n.className&&(l.className=n.className),n.style&&(l.renderer=function(e,t,l,a,o,r,i){Handsontable.renderers.TextRenderer.apply(this,arguments),t.style.color=n.style.color||"",t.style.backgroundColor=n.style.backgroundColor||"",t.style.fontSize=n.style.fontSize||"",t.style.lineHeight=n.style.lineHeight||""}))}),l},afterSetCellMeta:function(e,t,l,n){if("readOnly"===l||"className"===l||"style"===l){if(d=d.filter(function(n){return!(n.row===e&&n.col===t&&n[l])}),!1!==n&&""!==n){var r={row:e,col:t};r[l]=n,d.push(r)}var i={data:p.getSourceData(),meta:d};o.value=JSON.stringify(i),"readOnly"===l&&(p.getCellMeta(e,t).readOnly?a.disabled=!0:a.disabled=!1)}},afterChange:function(e,t){"loadData"!==t&&(i=p.getSourceData(),o.value=JSON.stringify({data:i,meta:d}))},afterSelection:function(e,l,n,o){if(u&&!g){let r=p.getActiveEditor(),i=r.TEXTAREA.value.slice(-1);y||e!==n||l!==o?(y||e!==n||l!==o)&&(h=Handsontable.helper.spreadsheetColumnLabel(o)+(n+1),A?f=/[\+\-\*\/^%]/.test(i)?`${f}${v}:${h}`:f.replace(/(\b[A-Z]+\d+|[A-Z]+\d+:[A-Z]+\d+)$/,`${v}:${h}`):(f=`=${v}:${h}`,A=!1)):(v=Handsontable.helper.spreadsheetColumnLabel(l)+(e+1),f=A?/[\+\-\*\/^%=(,]/.test(i)?f+v:f.replace(/(\b[A-Z]+\d+|[A-Z]+\d+:[A-Z]+\d+)$/,v):`=${v}`),a.value=f,g=!0,setTimeout(()=>{p.selectCell(E.row,E.col);let e=p.getActiveEditor();e&&!e.isOpened()&&(e.beginEditing(),e.TEXTAREA&&(e.TEXTAREA.value=f,e.open())),g=!1},0)}else{let d={from:{row:e,col:l},to:{row:n,col:o}};c=[],s={row:e,col:l};for(let m=d.from.row;m<=d.to.row;m++)for(let b=d.from.col;b<=d.to.col;b++)c.push({row:m,col:b});let w=p.getCellMeta(e,l),T=p.getSourceDataAtCell(e,l),$=w.style?w.style.fontSize:"12px";document.getElementById("font-size-dropdown").value=parseInt($);let C=w.className||"htLeft";C.includes("htCenter")?t.updateAlignmentIcon("htCenter"):C.includes("htRight")?t.updateAlignmentIcon("htRight"):t.updateAlignmentIcon("htLeft"),a.value=T||"",w.readOnly?(a.disabled=!0,_(!0)):(a.disabled=!1,_(!1))}},afterBeginEditing:function(){let e=p.getActiveEditor();e?.TEXTAREA?.addEventListener("input",b)},beforeKeyDown(e){if("Enter"===e.key&&u){f.includes("(")&&!f.includes(")")&&(f+=")");let t=p.getActiveEditor();t?.TEXTAREA&&(t.TEXTAREA.value=f),u=A=!1,m=!0,p.deselectCell()}}});function _(e){let t=document.querySelectorAll(".toolbar-btn");t.forEach(t=>{t.disabled=e,t.classList.toggle("disabled",e)})}function b(){if(m){m=!1;return}let e=p.getActiveEditor(),t=e.TEXTAREA.value;a.value=e.TEXTAREA.value,"="===t?(u=!0,E=s,f=t):")"===t.slice(-1)?A=u=!1:t.includes("=")&&/[\+\-\*\/^%=,]$|\b[A-Za-z]+\(/.test(t)?(A=u=!0,f=t):A=u=!1}t.initToolbar(p,()=>c),a.addEventListener("input",function(){s&&(u||"="!==a.value||(u=!0,E=s),p.setDataAtCell(s.row,s.col,a.value))}),a.addEventListener("keydown",function(e){"Enter"===e.key&&e.preventDefault()})}}});